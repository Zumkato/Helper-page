"""Attack chain builder page with drag-and-drop and LLM suggestions."""

from __future__ import annotations

import reflex as rx

from ...state.project_state import ProjectState


def _step_item(step: str, index: int) -> rx.Component:
    """Render a single sortable step item."""
    return rx.sortable_item(
        rx.box(step, padding="0.5em", border="1px solid", margin_y="0.25em"),
        id=str(index),
    )


def chain_page(project_id: int) -> rx.Component:  # pragma: no cover - UI code
    """Render the attack chain builder page."""
    return rx.vstack(
        rx.heading("Attack Chain Builder", size="lg"),
        rx.sortable(
            rx.foreach(ProjectState.chain_steps, _step_item),
            on_sort=ProjectState.reorder_chain_steps,
        ),
        rx.form(
            rx.hstack(
                rx.input(name="action", placeholder="New step", width="100%"),
                rx.button("Add", type="submit"),
            ),
            on_submit=ProjectState.handle_add_chain_step,
        ),
        rx.form(
            rx.hstack(
                rx.input(name="prompt", placeholder="Suggestion prompt", width="100%"),
                rx.button("Generate suggestions", type="submit"),
            ),
            on_submit=ProjectState.handle_generate_suggestions,
        ),
        rx.cond(
            ProjectState.suggestions != "",
            rx.box(
                ProjectState.suggestions,
                border="1px solid",
                padding="0.5em",
                margin_top="1em",
            ),
        ),
        rx.link("Back", href=f"/project/{project_id}"),
        spacing="1em",
    )
